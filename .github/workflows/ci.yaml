name: CI

on:
  push:
  pull_request:

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: develation_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      memcached:
        image: memcached:1.6
        ports:
          - 11211:11211
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.17.16
        env:
          discovery.type: single-node
          xpack.security.enabled: "false"
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
    strategy:
      matrix:
        php: ['8.1', '8.2', '8.3']
    env:
      DEV_ELATION_NETWORK_TESTS: "1"
      DEV_ELATION_EMAIL_TESTS: "1"
      DEV_ELATION_DBQUEUE_TESTS: "1"
      DEV_ELATION_MYSQL_HOST: 127.0.0.1
      DEV_ELATION_MYSQL_PORT: "3306"
      DEV_ELATION_MYSQL_USER: root
      DEV_ELATION_MYSQL_PASS: password
      DEV_ELATION_MYSQL_DB: develation_test
      DEV_ELATION_MONGO_URI: mongodb://127.0.0.1:27017
      DEV_ELATION_MEMCACHED_HOST: 127.0.0.1
      DEV_ELATION_MEMCACHED_PORT: "11211"
      DEV_ELATION_CURL_TEST_URL: https://www.bluefission.com
      DEV_ELATION_HTTP_TEST_URL: https://www.bluefission.com
      DEV_ELATION_STREAM_TEST_URL: https://bluefission.com
      DEV_ELATION_SOCKET_TEST_URL: https://bluefission.com
      DEV_ELATION_IO_FETCH_URL: https://bluefission.com
      DEV_ELATION_IO_STREAM_URL: https://bluefission.com
      DEV_ELATION_IO_SOCKET_URL: https://bluefission.com
      DEV_ELATION_REMOTE_TEST_URL: https://bluefission.com
    steps:
      - uses: actions/checkout@v4
      - run: echo "The ${{ github.repository }} repository has been cloned to the runner."
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, xml, mysqli, pdo_mysql, mongodb, redis, memcached
          coverage: none
      - name: Check PHP version
        run: php -v
      - uses: php-actions/composer@v6
      - run: echo "Composer dependencies have been installed"
      - name: Prepare CI logs
        run: mkdir -p artifacts/ci
      - name: Download PHPMD
        run: |
          mkdir -p artifacts
          curl -Ls -o artifacts/phpmd.phar https://github.com/phpmd/phpmd/releases/latest/download/phpmd.phar
          php artifacts/phpmd.phar --version
      - name: Lint PHP
        run: |
          set -o pipefail
          find src tests -name "*.php" -print0 | xargs -0 -n 1 php -l | tee artifacts/ci/php-lint.log
      - name: PHPMD (complexity baseline)
        run: |
          set -o pipefail
          for d in Async Behavioral Cli Collections Connections Data Exceptions HTML IPC Net Parsing Security Services System Utils; do
            php artifacts/phpmd.phar "src/$d" text phpmd.xml | tee -a artifacts/ci/phpmd.log
          done
          php artifacts/phpmd.phar tests text phpmd.xml | tee -a artifacts/ci/phpmd.log
      - name: PHPUnit
        run: |
          set -o pipefail
          vendor/bin/phpunit --do-not-cache-result --log-junit artifacts/ci/junit.xml | tee artifacts/ci/phpunit.log
      - name: Run CLI example
        run: |
          set -o pipefail
          php examples/cli/report.php --limit 2 --delay 0 | tee artifacts/ci/cli-example.log
      - name: Upload CI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: artifacts/ci
          retention-days: 14
